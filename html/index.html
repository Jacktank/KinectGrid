<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>KinectGrid Settings</title>
<link rel="stylesheet" type="text/css" href="style.css" />
<style>
</style>
<!--<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>-->
<script type="text/javascript" src="jquery_1.7.1_jquery.min.js"></script>
<script type="text/javascript" src="jquery.mousewheel.min.js"></script>
<!--<script type="text/javascript" src="jquery.dform-0.2.0.min.js"></script>-->
<script type="text/javascript" src="json2.min.js"></script>
<script type="text/javascript" src="kinect_settings.js"></script>
<script type="text/javascript" src="kinect_script.js"></script>
<script type="text/javascript">
	json_b9creator = null;
	refreshIntervall = null;

	/* This function checks the existance of a json struct
		 in the parent window and use this values if possible.
		 This reduce the loading calls of 'settings'.
	 */
	function refresh2(update){
		if( window.opener !== null && !window.opener.closed &&
				typeof(window.opener.json_b9creator) === "object" ){
			json_b9creator = window.opener.json_b9creator;
			if(update) update_fields(json_b9creator);
			else create_fields(json_b9creator);

		}else{
			send("settings","",
					function(data){
					json_b9creator = JSON.parse(data);//change global var
					if(update) update_fields(json_b9creator);
					else create_fields(json_b9creator);
					}
			);
		}
	}

/* Moreover, check opener.json_b9creator existens on creation, too. */
$(function(){
		refresh2(false);
		//refreshIntervall = window.setInterval("refresh2(true)", 1000);
		});

</script>
</head>
<body>
	<div class="containerL">
		<h1>Configs</h1>
		<div id="configs">
			<input type="button" value="Load Config" onclick="loadConfig()"/>
			<input id="configFilename" type="text" size="10" value="{{LAST_SETTING_FILENAME}}" />
			<input type="button" value="Save Config" onclick="saveConfig()"/>
		</div>	
		<div>
			<p>
			<input type="button" value="Start Area Detection" onclick="areaDetection(1)"/>
			<input type="button" value="Stop Area Detection" onclick="areaDetection(0)"/>
			</p>
			<p>
			<input type="button" value="Refit" onclick="repoke()" title="Try to find areas on previous saved positions" />
			</p>
		</div>
		<h1>View</h1>
		<input type="button" onclick="setView(1)" value="Raw depth image" />
		<input type="button" onclick="setView(2)" value="Depth mask" />
		<input type="button" onclick="setView(3)" value="Hand,Blob view" />
		<input type="button" onclick="setView(4)" value="Areas" />
		<input type="button" onclick="setView(5)" value="Frame" />
		<input type="button" onclick="setView(6)" value="No image refresh (saves cpu time)" />
		<h1>Load/Save Masks</h1>
		<input type="button" onclick="loadMasks()" value="Load masks" />
		<input type="button" onclick="saveMasks()" value="Save masks" />
		<p>Frameless mode: If your frame is not present you can load former depth and area mask.</p>
		<p>Filename pattern: {Configname}_[depth|area].png</p>
		<h1>End program</h1>
		<input type="button" onclick="quit()" value="Quit" />
	</div>
	<div class="containerL">
		<h1>Variables<a style="font-size:70%;float:right;" href="javascript:resetConfig();">(Reset values)</a></h1>
		<div id="settingKinectForm">AAA</div>
		<div class="prop" id="kinectMotorAngle"></div>
		<div class="prop" id="minDepth"></div>
		<div class="prop" id="maxDepth"></div>
		<div class="prop" id="minBloabArea"></div>
		<div class="prop" id="maxBlobArea"></div>
		<div class="prop" id="marginLeft"></div>
		<div class="prop" id="marginRight"></div>
		<div class="prop" id="marginTop"></div>
		<div class="prop" id="marginBottom"></div>
		<div class="prop" id="marginFront"></div>
		<div class="prop" id="marginBack"></div>
		<div class="prop" id="TUIO_2Dcur"></div>
		<div class="prop" id="TUIO_25Dblb"></div>
		<div class="prop" id="areaThresh"></div>
		<div class="prop" id="directFiltering"></div>
		<div class="prop" id="clipping"></div>
	</div>
	<div class="containerL" id="desc_calibration">
		<h1>Calibration</h1>
		Note that the raw depth values (0-2048) will be flipped: 255=close points, 0=distant points.
		<ol>
			<li>Set Depth Range
			<ol>
				<li>Select raw depth view (press '1')</li>
				<li>Raise <i>minDepth</i> till first obstacles are light grey.</li>
				<li>Lower <i>maxDepth</i> till background is nearly black.</li>
			</ol>
			</li>
			<li>Use <i>margin[Left|Top|Right|Bottom]</i> to crop image.
			</li>
			<li>Select front mask image
			<ol>
				<li>Select front mask view (press '5')</li>
				<li>Raise <i>marginFront</i> till the frame is white and all other parts still black.</li>
			</ol>
			This black/white-image will used to find the 'holes' of your frame. Ensure that the areas are full enclosed.
			</li>
			<li>Use <i>marginBack</i> to set the minimal background threshold (depth mask) for blob detection.<br> Press '2' to show the depth mask. This global threshold will increased pixelwise in two cases:
			<ol>
				<li>During the depth mask creation on startup (and configuration changes) by all obstacles.
				(Roughly <i>depthMask = max(sensordata, 255-marginBack)</i>). Thus, do not block the camera during initialisation. 				
				</li>
				<li>If the option <i>areaThresh</i> is enabled, the depth mask inside an area depends by its border pixel distances.</li>
			</ol>
			</li>
			<li>Save Configuration</li>
		</ol>
	</div>
	<div class="containerL">
		<h1>Area Detection</h1>
		If the calibration was finished (<i>mask view</i> looks feasible and <i>blob view</i> do not react on tiny, undesired disturbances) you can start the area detection.<br>
		Click on <i>Start Area Detection</i>, place behind the frame, and push a hand in the first area. Select more areas and finish area detection with an second push into area 1.
		<h1>Refit</h1>
		Use this option to repeat the area detection. It search areas nearby the saved midpoints.
		<h1>Load/Save Masks</h1>
		If you want remove the frame after the setup you can click on <i>Save mask</i>. This creates two images ({Configname}_[depth|area].png), which will be loaded at startup and reconstruct the previous depth filter and area definition. Remove this files to restore the normal startup behaviour.
	</div>
	<div class="containerL">
		<h1>Variables Description</h1>
		minBlobArea, maxBlobArea: Filter small and tall blobs out.<br>
		TUIO_2Dcur : Send tuio messages in 2Dcur format<br>
		TUIO_25Dblb : Send tuio messages in 25Dblb format (like Space Palette).<br>
		areaThresh : Use depth of the frame to filter hand movement behind the frame.<br>
		directFiltering: Skip depthFrame evaluation to avoid some memcpy. (For ARM, Slower on x86.)<br>
	</div>

	<hr style="clear:both;margin-top:3em;" />

	<div class="containerL">
		<h1>Log</h1>
		<div class="prop" id="serialMessages"></div>
	</div>
	<div class="containerR preview" id="previewContainer" xxx="{{ONION_LINE_BREAK_FIX}}">
		<h1>Preview</h1>
		<p>Blub
		<span style="padding-left:3em" >Automatic refresh: <input id="previewRefresh" type="checkbox" checked="checked" /> 
			Scale: <select id="previewScale">
				<option value="100">100%</option>
				<option value="50" selected>50%</option>
				<option value="25" >25%</option>
			</select>
		</span>
		<span id="info"></span>
		</p>
		<span id="previewImg" onClick="reloadImage(true)" title="Click to reload."><img src="preview.png?scale=50&force=1" /></span>
	</div>

	<hr style="clear:both;margin-top:3em;" />

	<div class="containerL" >
		<img src="sketchFront.png" style="max-width:100%"/>
	</div>
	<div class="containerR" >
		<img src="sketchSide.png" style="max-width:100%"/>
	</div>
</body>
